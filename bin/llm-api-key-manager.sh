#!/usr/bin/env bash
set -euo pipefail

# KH LLM TransQueue - OpenAI API Key Manager (Portable)

# [FIXED] Dynamic Relative Path
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
CONF_DIR="$BASE_DIR/conf"
KEY_FILE="$CONF_DIR/openai_api.key"
ENV_FILE="$CONF_DIR/openai_api.env"

mkdir -p "$CONF_DIR"

line() { printf '\n==================== %s ====================\n\n' "$1"; }

show_status() {
  line "Current OpenAI API Key Status"

  if [[ -f "$KEY_FILE" ]]; then
    key="$(tr -d '\r\n' < "$KEY_FILE")"
    len="${#key}"
    if (( len == 0 )); then
      echo "[INFO] Key file exists but is empty."
    else
      # Masking: Show first 4 + last 4 chars
      head4="${key:0:4}"
      tail4="${key: -4}"
      hidden_len=$(( len - 8 ))
      if (( hidden_len < 0 )); then hidden_len=0; fi
      mask=""
      for ((i=0; i<hidden_len; i++)); do mask="${mask}*"; done
      
      echo "[OK] Key Length: ${len} chars"
      echo "[OK] Key Preview: ${head4}${mask}${tail4}"
    fi
  else
    echo "[INFO] No key file found ($KEY_FILE)"
  fi
}

set_key() {
  line "Enter New OpenAI API Key"

  read -r -s -p "Enter your API Key (sk-...): " key
  echo
  read -r -s -p "Confirm API Key: " key2
  echo

  if [[ "$key" != "$key2" ]]; then
    echo "[ERROR] Keys do not match. Aborted."
    return 1
  fi

  if [[ -z "$key" ]]; then
    echo "[ERROR] Key cannot be empty."
    return 1
  fi

  # Trim whitespace
  key="$(echo -n "$key" | tr -d '[:space:]')"

  echo "$key" > "$KEY_FILE"
  cat > "$ENV_FILE" <<EOF_ENV
# auto-generated by llm-api-key-manager.sh
export OPENAI_API_KEY="$key"
EOF_ENV

  chmod 600 "$KEY_FILE" "$ENV_FILE" || true

  echo
  echo "[OK] Key saved successfully."
  echo "  - $KEY_FILE"
  echo "  - $ENV_FILE"
}

delete_key() {
  line "Delete API Key"

  if [[ ! -f "$KEY_FILE" && ! -f "$ENV_FILE" ]]; then
    echo "[INFO] No key files to delete."
    return 0
  fi

  read -r -p "Are you sure you want to delete the key? (y/n): " ans
  case "$ans" in
    yes|y|Y)
      if [[ -f "$KEY_FILE" ]]; then rm -f "$KEY_FILE"; echo "[DEL] $KEY_FILE deleted."; fi
      if [[ -f "$ENV_FILE" ]]; then rm -f "$ENV_FILE"; echo "[DEL] $ENV_FILE deleted."; fi
      ;;
    *)
      echo "[CANCEL] Deletion cancelled."
      ;;
  esac
}

main_menu() {
  while true; do
    echo
    echo "==== KH LLM TransQueue - Key Manager ===="
    echo " 1) Check Key Status"
    echo " 2) Set / Update Key"
    echo " 3) Delete Key"
    echo " 4) Exit"
    echo "========================================="
    read -r -p "Select option: " choice
    case "$choice" in
      1) show_status ;;
      2) set_key ;;
      3) delete_key ;;
      4) echo "Bye."; break ;;
      *) echo "Invalid option." ;;
    esac
  done
}

main_menu
