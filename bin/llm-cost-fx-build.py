#!/usr/bin/env python3
import sys, json, datetime

if len(sys.argv) != 3:
    print("Usage: llm-cost-fx-build.py JSON_FILE OUT_CONF", file=sys.stderr)
    sys.exit(1)

json_path, out_path = sys.argv[1], sys.argv[2]

with open(json_path, "r", encoding="utf-8") as f:
    raw = f.read().strip()

if not raw:
    print("[ERROR] No JSON data in", json_path, file=sys.stderr)
    sys.exit(1)

try:
    data = json.loads(raw)
except Exception as e:
    print("[ERROR] Failed to parse JSON:", e, file=sys.stderr)
    sys.exit(1)

# open.er-api.com:
#   - 일부 응답: "rates"
#   - 일부 응답: "conversion_rates"
rates = data.get("rates") or data.get("conversion_rates")
if not isinstance(rates, dict):
    print("[ERROR] Could not find 'rates' or 'conversion_rates' dict in JSON", file=sys.stderr)
    sys.exit(1)

label_map = {
    "KRW": "Korean won",
    "USD": "US dollar",
    "AED": "UAE dirham",
    "ARS": "Argentine peso",
    "AUD": "Australian dollar",
    "BHD": "Bahraini dinar",
    "BDT": "Bangladeshi taka",
    "BND": "Brunei dollar",
    "BRL": "Brazilian real",
    "CAD": "Canadian dollar",
    "CHF": "Swiss franc",
    "CLP": "Chilean peso",
    "CNY": "Chinese yuan",
    "COP": "Colombian peso",
    "CZK": "Czech koruna",
    "DKK": "Danish krone",
    "EGP": "Egyptian pound",
    "EUR": "Euro",
    "ETB": "Ethiopian birr",
    "FJD": "Fijian dollar",
    "GBP": "British pound",
    "HKD": "Hong Kong dollar",
    "HUF": "Hungarian forint",
    "IDR": "Indonesian rupiah",
    "ILS": "Israeli shekel",
    "INR": "Indian rupee",
    "JOD": "Jordanian dinar",
    "JPY": "Japanese yen",
    "KES": "Kenyan shilling",
    "KHR": "Cambodian riel",
    "KWD": "Kuwaiti dinar",
    "KZT": "Kazakhstani tenge",
    "LKR": "Sri Lankan rupee",
    "LYD": "Libyan dinar",
    "MNT": "Mongolian tugrik",
    "MOP": "Macanese pataca",
    "MXN": "Mexican peso",
    "MYR": "Malaysian ringgit",
    "NOK": "Norwegian krone",
    "NPR": "Nepalese rupee",
    "NZD": "New Zealand dollar",
    "OMR": "Omani rial",
    "PHP": "Philippine peso",
    "PKR": "Pakistani rupee",
    "PLN": "Polish zloty",
    "QAR": "Qatari riyal",
    "RON": "Romanian leu",
    "RUB": "Russian ruble",
    "SAR": "Saudi riyal",
    "SEK": "Swedish krona",
    "SGD": "Singapore dollar",
    "THB": "Thai baht",
    "TRY": "Turkish lira",
    "TWD": "New Taiwan dollar",
    "TZS": "Tanzanian shilling",
    "UAH": "Ukrainian hryvnia",
    "UZS": "Uzbekistani som",
    "VND": "Vietnamese dong",
    "ZAR": "South African rand",
}

all_codes = sorted(label_map.keys())
ordered_codes = ["KRW", "USD"] + [c for c in all_codes if c not in ("KRW", "USD")]

ts = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

with open(out_path, "w", encoding="utf-8") as f:
    f.write("# llm-cost-fx.conf\n")
    f.write("# CURRENCY  RATE_PER_USD  LABEL\n")
    f.write(f"# (generated by llm-cost-fx-update.sh on {ts})\n")
    f.write("# base currency: USD\n\n")

    for code in ordered_codes:
        label = label_map[code]
        raw_rate = rates.get(code)

        if raw_rate is None:
            print(f"# WARN: rate for {code} not found in API, fallback=1.0", file=sys.stderr)
            rate = 1.0
        else:
            try:
                rate = float(raw_rate)
            except Exception:
                print(f"# WARN: non-numeric rate for {code} ({raw_rate!r}), fallback=1.0", file=sys.stderr)
                rate = 1.0

        f.write(f"{code:<4} {rate:12.6f} {label}\n")

print(f"[OK] Wrote FX table to {out_path}")
